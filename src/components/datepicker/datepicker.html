<div class="m-datepicker">
    <m-popup padding="" :open="isOpen" @open="onOpen" @close="onClose" :options="options" :disabled="disabled" focusManagement=""
        placement="bottom-start">

        <m-input-style :state="datepickerState" :label="label" :focus="isFocus" :empty="false">
            <input class="m-text-field__input" :disabled="isDisabled" :placeholder="placeholder" @focus="onFocus" @blur="onBlur"
                ref="input" v-model="formattedDate" @keydown="isOpen = true">
            <m-button slot="right-content" mode="icon" icon-name="calendar">{{ isOpen ? closeCalendarDesc : openCalendarDesc }}</m-button>
        </m-input-style>

        <div class="m-datepicker__wrap" slot="body">
            <div class="m-datepicker__header">
                <m-button mode="icon" icon-name="left-arrow" @click="selectYear(selectedYear - 1)" :state="isMinYear? 'disabled' : ''" :class="{'m--is-disabled': isMinYear}">previous year</m-button>
                <button type="button" @click="showYears" class="m-datepicker__years">{{selectedYear}}</button>
                <m-button mode="icon" icon-name="right-arrow" @click="selectYear(selectedYear + 1)" :state="isMaxYear? 'disabled' : ''" :class="{'m--is-disabled': isMaxYear}">next year</m-button>
                <m-button mode="icon" icon-name="left-arrow" @click="selectMonth(selectedMonth - 1)" :state="isMinMonth? 'disabled' : ''"
                    :class="{'m--is-disabled': isMinMonth}">previous month</m-button>
                <button type="button" @click="view = 'month'" class="m-datepicker__months">{{selectedMonthName}}</button>
                <m-button mode="icon" icon-name="right-arrow" @click="selectMonth(selectedMonth + 1)" :state="isMaxMonth? 'disabled' : ''"
                    :class="{'m--is-disabled': isMaxMonth}">next month</m-button>
            </div>
            <div class="m-datepicker__body" ref="body">
                <table class="m-datepicker__body-table">
                    <template v-if="view == 'year'">
                        <tr v-for="yearRow in years">
                            <td v-for="y in yearRow" class="m-datepicker__body-cell">
                                <button type="button" @click.stop="selectYear(y, true)" :class="{'m--is-selected': selectedYear == y}" class="m-datepicker__item">{{y}}</button>
                            </td>
                        </tr>
                    </template>
                    <template v-if="view == 'month'">
                        <tr v-for="monthRow in months">
                            <td v-for="m in monthRow" class="m-datepicker__body-cell">
                                <button type="button" @click.stop="selectMonth(m.index, true)" :class="{'m--is-selected': selectedMonthName == m.name, 'm--is-disabled': m.isDisabled}"
                                    class="m-datepicker__item" :disabled="m.isDisabled">{{m.name}}</button>
                            </td>
                        </tr>
                    </template>
                    <template v-if="view == 'day'">
                        <tr>
                            <td v-for="w in weekdays" class="m-datepicker__weekday">{{w}}</td>
                        </tr>
                        <tr v-for="dayRow in daysOfMonth">
                            <td v-for="d in dayRow" class="m-datepicker__body-cell">
                                <button :class="{'m--is-selected': d.isSelected, 'm--is-today': d.isToday, 'm--is-disabled': d.isDisabled, 'm--is-other-month': d.month != selectedMonth}"
                                    type="button" @click="selectDate(d)" class="m-datepicker__item">{{d.date}}</button>
                            </td>
                        </tr>
                    </template>
                </table>
            </div>
        </div>
    </m-popup>
    <m-validation-message :error-message="errorMessage || error" :valid-message="validMessage" :helper-message="helperMessage"
        v-if="!isDisabled"></m-validation-message>
</div>
